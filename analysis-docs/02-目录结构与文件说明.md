# KAI Scheduler 目录结构与文件说明

## 目录树概览

```
KAI-Scheduler/
├── build/              # 构建相关文件
├── cmd/                # 各组件的入口程序
├── deployments/        # 部署配置（Helm Charts）
├── docs/               # 项目文档
├── examples/           # 示例配置
├── hack/               # 开发辅助脚本
├── pkg/                # 核心代码包
└── test/               # 测试代码
```

## 1. build/ - 构建目录

### 1.1 build/builder/
- **Dockerfile**: 多阶段构建的 Dockerfile，用于构建所有组件的容器镜像

### 1.2 build/makefile/
- **base.mk**: 基础 Makefile 规则
- **golang.mk**: Go 语言相关的构建规则
- **index.mk**: 索引和组织其他 Makefile
- **testenv.mk**: 测试环境配置

**用途**: 提供统一的构建系统，支持多组件并行构建和容器化。

## 2. cmd/ - 组件入口目录

### 2.1 cmd/scheduler/
**用途**: 调度器主程序
- **main.go**: 程序入口
- **app/server.go**: 调度器服务器初始化
- **app/options/options.go**: 命令行参数和配置
- **profiling/**: 性能分析支持（Pyroscope 集成）

**功能**: 
- 初始化调度器配置
- 启动调度循环
- 提供 HTTP 端点（健康检查、指标、性能分析）

### 2.2 cmd/binder/
**用途**: Pod 绑定处理器
- **main.go**: 程序入口
- **app/app.go**: Binder 应用初始化
- **app/options.go**: 配置选项

**功能**:
- 监听 BindRequest CRD
- 执行 Pod 到节点的绑定
- 处理 GPU 预留和 DRA 资源
- 失败重试和回滚

### 2.3 cmd/podgrouper/
**用途**: PodGroup 自动创建和管理
- **main.go**: 程序入口
- **app/app.go**: PodGrouper 控制器

**功能**:
- 监听 Pod 创建事件
- 识别 Pod 的顶层 Owner
- 根据工作负载类型创建对应的 PodGroup
- 支持多种工作负载（Job, PyTorchJob, MPIJob, Ray 等）

### 2.4 cmd/podgroupcontroller/
**用途**: PodGroup 状态管理
- **main.go**: 程序入口
- **app/app.go**: 控制器逻辑

**功能**:
- 同步 PodGroup 状态
- 更新资源使用指标
- 处理 PodGroup 生命周期事件

### 2.5 cmd/queuecontroller/
**用途**: 队列管理控制器
- **main.go**: 程序入口
- **app/app.go**: 队列控制器

**功能**:
- 管理队列层次结构
- 计算队列资源配额
- 发布队列指标到 Prometheus

### 2.6 cmd/admission/
**用途**: 准入控制 Webhook
- **main.go**: 程序入口
- **app/app.go**: Webhook 服务器

**功能**:
- 验证 Pod 配置
- 变更 Pod 规范（注入标签、注解等）
- 验证 Queue 和 PodGroup CRD

### 2.7 cmd/operator/
**用途**: KAI Operator（管理 KAI 组件）
- **main.go**: 程序入口
- **app/app.go**: Operator 逻辑
- **config/**: 配置管理

**功能**:
- 管理 SchedulingShard CRD
- 部署和配置 KAI 组件
- 管理 Prometheus 集成

### 2.8 cmd/nodescaleadjuster/
**用途**: 节点扩缩容调整器
- **main.go**: 程序入口
- **app/app.go**: 调整器逻辑

**功能**:
- 与云提供商的自动扩缩容器集成
- 调整节点池大小
- 优化资源利用率

### 2.9 cmd/resourcereservation/
**用途**: GPU 资源预留服务
- **main.go**: 程序入口
- **app/app.go**: 预留服务

**功能**:
- 管理 GPU 预留 Pod
- 协调 GPU 共享
- 处理 GPU 设备分配

### 2.10 cmd/fairshare-simulator/
**用途**: 公平共享模拟器
- **main.go**: 模拟器入口
- **README.md**: 使用说明

**功能**:
- 模拟公平共享算法
- 可视化资源分配
- 用于测试和调优

### 2.11 cmd/time-based-fairshare-simulator/
**用途**: 基于时间的公平共享模拟器
- **main.go**: 模拟器入口
- **examples/**: 示例配置
- **README.md**: 使用说明

**功能**:
- 模拟时间衰减的公平性算法
- 生成资源分配时间序列
- 支持多队列场景

### 2.12 cmd/snapshot-tool/
**用途**: 集群快照工具
- **main.go**: 工具入口

**功能**:
- 捕获集群状态快照
- 用于调试和重现调度问题

### 2.13 cmd/scalingpod/
**用途**: Pod 扩缩容工具
- **main.go**: 工具入口

**功能**:
- 测试和演示弹性工作负载

## 3. pkg/ - 核心代码包

### 3.1 pkg/scheduler/ - 调度器核心

#### 3.1.1 pkg/scheduler/scheduler.go
**用途**: 调度器主逻辑
- 初始化调度器
- 运行调度循环
- 管理调度会话

#### 3.1.2 pkg/scheduler/framework/
**用途**: 调度框架
- **framework.go**: 框架初始化
- **session.go**: 会话管理
- **statement.go**: 事务式调度操作
- **plugins.go**: 插件注册和管理
- **event.go**: 事件处理
- **operations.go**: 调度操作（分配、驱逐等）

**核心概念**:
- Session: 单个调度周期的上下文
- Statement: 类似事务的操作组
- Plugin: 扩展点机制

#### 3.1.3 pkg/scheduler/actions/
**用途**: 调度动作实现

##### actions/allocate/
- **allocate.go**: 资源分配动作
- **allocateGang_test.go**: Gang 调度测试
- **allocateElastic_test.go**: 弹性工作负载测试
- **allocateTopology_test.go**: 拓扑感知测试

**功能**: 为待调度的 Pod 分配节点和资源

##### actions/consolidate/
- **consolidation.go**: 工作负载整合动作

**功能**: 重新分配运行中的 Pod 以减少碎片

##### actions/reclaim/
- **reclaim.go**: 资源回收动作

**功能**: 从超配额队列回收资源给配额不足的队列

##### actions/preempt/
- **preempt.go**: 抢占动作

**功能**: 高优先级作业抢占低优先级作业

##### actions/stalegangeviction/
- **stalegangeviction.go**: 过期 Gang 驱逐

**功能**: 清理不满足 minMember 的 PodGroup

##### actions/common/
- **action.go**: 动作接口定义
- **allocate.go**: 通用分配逻辑
- **feasible_nodes.go**: 可行节点过滤
- **solvers/**: 调度求解器

#### 3.1.4 pkg/scheduler/plugins/
**用途**: 调度器插件

##### plugins/proportion/
- **proportion.go**: 公平共享插件
- **resource_division/**: 资源分配算法
- **resource_share/**: 资源共享计算
- **reclaimable/**: 可回收资源策略
- **queue_order/**: 队列排序
- **capacity_policy/**: 容量策略

**功能**: 实现 DRF 和公平共享算法

##### plugins/topology/
- **topology_plugin.go**: 拓扑感知插件
- **topology_utils.go**: 拓扑工具函数
- **node_scoring.go**: 节点评分
- **job_filtering.go**: 作业过滤

**功能**: 基于物理拓扑优化 Pod 放置

##### plugins/gpupack/
- **gpupack.go**: GPU 打包插件

**功能**: 优化 GPU 节点的 Bin Packing

##### plugins/gpuspread/
- **gpuspread.go**: GPU 分散插件

**功能**: 将 GPU 工作负载分散到多个节点

##### plugins/elastic/
- **elastic.go**: 弹性工作负载插件

**功能**: 支持动态扩缩容的工作负载

##### plugins/predicates/
- **predicates.go**: 谓词插件

**功能**: 节点过滤条件

##### plugins/priority/
- **priority.go**: 优先级插件

**功能**: 作业优先级管理

##### plugins/dynamicresources/
- **dynamicresources.go**: 动态资源分配插件

**功能**: 支持 Kubernetes DRA

##### plugins/minruntime/
- **minruntime.go**: 最小运行时间插件

**功能**: 保证作业最小运行时间，避免频繁抢占

##### plugins/snapshot/
- **snapshot.go**: 快照插件

**功能**: 捕获和分析集群快照

##### 其他插件
- **nodeavailability/**: 节点可用性检查
- **nodeplacement/**: 节点放置策略
- **podaffinity/**: Pod 亲和性
- **kubeflow/**: Kubeflow 集成
- **ray/**: Ray 集成

#### 3.1.5 pkg/scheduler/cache/
**用途**: 调度器缓存

- **cache.go**: 缓存实现
- **interface.go**: 缓存接口
- **cluster_info/**: 集群信息管理
- **status_updater/**: 状态更新器
- **evictor/**: 驱逐器
- **usagedb/**: 使用数据库

**功能**:
- 维护集群状态
- 提供快照功能
- 管理资源使用历史

##### cache/usagedb/
- **usagedb.go**: 使用数据库接口
- **prometheus/**: Prometheus 集成
- **fake/**: 测试用假实现
- **api/**: API 定义

**功能**: 存储和查询历史资源使用数据

#### 3.1.6 pkg/scheduler/api/
**用途**: 调度器 API 类型

- **types.go**: 核心类型定义
- **cluster_info.go**: 集群信息
- **pod_info/**: Pod 信息
- **node_info/**: 节点信息
- **podgroup_info/**: PodGroup 信息
- **queue_info/**: 队列信息
- **resource_info/**: 资源信息
- **topology_info/**: 拓扑信息

**功能**: 定义调度器内部使用的数据结构

#### 3.1.7 pkg/scheduler/k8s_internal/
**用途**: Kubernetes 内部集成

- **k8s_internal.go**: K8s 内部接口
- **plugins/**: K8s 插件集成
- **predicates/**: K8s 谓词

**功能**: 集成 Kubernetes 原生调度逻辑

#### 3.1.8 pkg/scheduler/metrics/
**用途**: 指标收集

- **metrics.go**: Prometheus 指标定义

**功能**: 导出调度器性能和状态指标

### 3.2 pkg/binder/ - Binder 组件

#### 3.2.1 pkg/binder/binding/
- **binder.go**: Binder 核心逻辑
- **interface.go**: Binder 接口
- **resourcereservation/**: 资源预留

**功能**: 执行 Pod 绑定和资源预留

#### 3.2.2 pkg/binder/controllers/
- **bindrequest_controller.go**: BindRequest 控制器
- **pod_controller.go**: Pod 控制器

**功能**: 监听和处理 BindRequest 事件

#### 3.2.3 pkg/binder/plugins/
- **gpusharing/**: GPU 共享插件
- **k8s-plugins/**: K8s 插件（卷绑定、DRA）
- **state/**: 绑定状态管理

**功能**: 扩展 Binder 功能

### 3.3 pkg/podgrouper/ - PodGrouper 组件

#### 3.3.1 pkg/podgrouper/podgrouper/
- **podgrouper.go**: PodGrouper 核心逻辑
- **hub/**: 插件中心
- **plugins/**: 各种工作负载插件

**功能**: 自动创建和管理 PodGroup

#### 3.3.2 pkg/podgrouper/podgrouper/plugins/
- **job/**: Job 插件
- **deployment/**: Deployment 插件
- **kubeflow/**: Kubeflow 插件（PyTorch, MPI, TensorFlow 等）
- **ray/**: Ray 插件
- **jobset/**: JobSet 插件
- **grove/**: Grove 插件
- **defaultgrouper/**: 默认分组器

**功能**: 为不同类型的工作负载创建 PodGroup

### 3.4 pkg/podgroupcontroller/ - PodGroup 控制器

- **controllers/**: 控制器实现
- **utilities/**: 工具函数

**功能**: 管理 PodGroup 生命周期和状态

### 3.5 pkg/queuecontroller/ - 队列控制器

- **controllers/**: 控制器实现
- **metrics/**: 队列指标
- **common/**: 通用逻辑

**功能**: 管理队列层次结构和资源分配

### 3.6 pkg/admission/ - 准入控制

- **webhook/**: Webhook 服务器
- **plugins/**: 准入插件

**功能**: 验证和变更 Pod、Queue、PodGroup

### 3.7 pkg/operator/ - Operator 组件

- **controller/**: Operator 控制器
- **operands/**: 操作数管理
- **config/**: 配置管理
- **cert-utils/**: 证书工具

**功能**: 管理 KAI 组件的部署和配置

### 3.8 pkg/nodescaleadjuster/ - 节点扩缩容

- **controller/**: 控制器
- **scale_adjuster/**: 扩缩容逻辑
- **scaler/**: 扩缩容器接口

**功能**: 与云提供商集成，调整节点池

### 3.9 pkg/resourcereservation/ - 资源预留

- **discovery/**: 资源发现
- **patcher/**: 资源修补
- **poddetails/**: Pod 详情

**功能**: 管理 GPU 预留 Pod

### 3.10 pkg/apis/ - API 定义

#### 3.10.1 pkg/apis/scheduling/
- **v2/**: Queue CRD v2
- **v2alpha2/**: PodGroup CRD v2alpha2
- **v1alpha2/**: BindRequest CRD v1alpha2

**功能**: 定义自定义资源（CRD）

#### 3.10.2 pkg/apis/kai/
- **v1/**: KAI 配置 API
- **v1alpha1/**: Topology CRD

**功能**: 定义 KAI 特定的 CRD

#### 3.10.3 pkg/apis/client/
- **clientset/**: 客户端集
- **informers/**: Informer 工厂
- **listers/**: Lister 接口

**功能**: 生成的客户端代码

### 3.11 pkg/common/ - 通用代码

- **constants/**: 常量定义
- **feature_gates/**: 特性门控
- **flags/**: 命令行标志
- **k8s_utils/**: K8s 工具函数
- **podgroup/**: PodGroup 工具
- **resources/**: 资源工具

**功能**: 跨组件共享的通用代码

## 4. deployments/ - 部署配置

### 4.1 deployments/kai-scheduler/
**用途**: Helm Chart

- **Chart.yaml**: Chart 元数据
- **values.yaml**: 默认配置值
- **templates/**: K8s 资源模板
- **crds/**: CRD 定义
- **scripts/**: 部署脚本

**功能**: 使用 Helm 部署 KAI Scheduler

### 4.2 deployments/crd-upgrader/
**用途**: CRD 升级工具

- **Dockerfile**: 升级工具镜像
- **apply-crds.sh**: CRD 应用脚本

**功能**: 安全升级 CRD 版本

## 5. docs/ - 文档目录

### 5.1 docs/developer/
**用途**: 开发者文档

- **scheduler-concepts.md**: 调度器核心概念
- **action-framework.md**: 动作框架
- **plugin-framework.md**: 插件框架
- **binder.md**: Binder 文档
- **pod-grouper.md**: PodGrouper 文档
- **building-from-source.md**: 从源码构建
- **designs/**: 设计文档

### 5.2 docs/batch/
**用途**: 批处理作业文档

- **README.md**: 批处理概述
- **batch-job.yaml**: 示例
- **pytorch-job.yaml**: PyTorch 示例

### 5.3 docs/fairness/
**用途**: 公平性文档

- **README.md**: 公平性算法说明

### 5.4 docs/queues/
**用途**: 队列文档

- **README.md**: 队列配置和使用

### 5.5 docs/gpu-sharing/
**用途**: GPU 共享文档

- **README.md**: GPU 共享概述
- **gpu-sharing.yaml**: 示例
- **mps/**: MPS 支持
- **autoscaling/**: 自动扩缩容

### 5.6 docs/topology/
**用途**: 拓扑感知文档

- **README.md**: 拓扑感知调度
- **multilevel.md**: 多级拓扑

### 5.7 docs/elastic/
**用途**: 弹性工作负载文档

- **README.md**: 弹性工作负载
- **pytorch-elastic.yaml**: 示例

### 5.8 docs/time-based-fairshare/
**用途**: 基于时间的公平共享文档

- **README.md**: 时间衰减公平性

### 5.9 docs/metrics/
**用途**: 指标文档

- **METRICS.md**: 指标列表
- **README.md**: 监控配置

### 5.10 docs/operator/
**用途**: Operator 文档

- **README.md**: Operator 使用
- **scheduling-shards.md**: 调度分片

## 6. examples/ - 示例配置

- **quickstart/**: 快速开始示例
- **ray/**: Ray 集成示例
- **time-based-fairshare/**: 时间公平性示例

## 7. hack/ - 开发脚本

- **run-e2e-kind.sh**: 在 Kind 中运行 E2E 测试
- **setup-e2e-cluster.sh**: 设置 E2E 集群
- **update-client.sh**: 更新生成的客户端代码
- **replace_headers.sh**: 替换文件头
- **third_party_integrations/**: 第三方集成脚本

## 8. test/ - 测试目录

### 8.1 test/e2e/
**用途**: 端到端测试

- 各种场景的集成测试
- 使用 Ginkgo 测试框架

## 9. 根目录文件

- **Makefile**: 主构建文件
- **Dockerfile**: 容器镜像构建
- **go.mod**: Go 模块定义
- **go.sum**: Go 依赖校验和
- **README.md**: 项目说明
- **LICENSE**: Apache 2.0 许可证
- **CHANGELOG.md**: 变更日志
- **CONTRIBUTING.md**: 贡献指南
- **GOVERNANCE.md**: 治理模型
- **MAINTAINERS.md**: 维护者列表
- **OWNERS**: 代码所有者
- **SUPPORT.md**: 支持策略

## 总结

KAI Scheduler 的代码组织清晰，模块化程度高：

1. **cmd/** 包含所有可执行组件的入口
2. **pkg/** 包含核心业务逻辑，按功能模块划分
3. **deployments/** 提供生产级部署配置
4. **docs/** 包含详尽的文档
5. **test/** 包含完整的测试套件

这种结构使得项目易于理解、维护和扩展。

